const { BroadlinkDeviceSP2, BroadlinkDeviceMP1, BroadlinkDeviceRM2 } = require('broadlink-js');
const { createDevice } = require('../utils/broadlink.createDevice');

/**
 * @description Store discovered peripheral.
 * @param {Object} peripheralInfo - Peripheral information generated by Broadlink library.
 * @example
 * gladys.broadlink.addPeripheral({
 *  name: 'RM3 Pro Plus',
 *  address: '192.168.1.1',
 *  ...
 * });
 */
function addPeripheral(peripheralInfo) {
  let broadlinkDevice;
  let device;
  let nbSwitches = 0;

  switch (peripheralInfo.module) {
    case 'sp2': {
      broadlinkDevice = new BroadlinkDeviceSP2(peripheralInfo);
      nbSwitches = 1;
      break;
    }
    case 'unknow':
    case 'rm2': {
      broadlinkDevice = new BroadlinkDeviceRM2(peripheralInfo);
      break;
    }
    case 'mp1': {
      broadlinkDevice = new BroadlinkDeviceMP1(peripheralInfo);
      nbSwitches = 4;
      break;
    }
    default:
      throw new Error(`Broadlink ${peripheralInfo.module} is not recognized.`);
  }

  const mac = peripheralInfo.mac.toString('hex');
  if (nbSwitches > 0) {
    device = createDevice(peripheralInfo.name, peripheralInfo.module, mac, 4, this.serviceId);
  }

  const peripheral = {
    name: peripheralInfo.name,
    address: peripheralInfo.address,
    mac,
    canLearn: !!broadlinkDevice.learnCode,
    device,
  };
  this.peripherals[peripheral.mac] = peripheral;
  this.broadlinkDevices[peripheral.mac] = broadlinkDevice;
}

module.exports = {
  addPeripheral,
};
